name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Release"
        required: true
        default: false
        type: boolean
      android_version:
        required: true
        type: string
        default: android12
      kernel_version:
        required: true
        type: string
        default: 5.10
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_stock
      BUILD_TIME:
        type: string
        description: "Custom build time (Enter F to use current time)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix (leave empty for a random string)"
        required: false
        default: "DareDevilü™Ñ"
      FAST_BUILD:
        type: boolean
        description: "Enable fast build?"
        required: true
        default: true
      SUSFS_CI:
        type: choice
        description: "SUSFS module download method"
        required: true
        default: CI
        options:
          - CI
          - Release
          - NoN
      KSU_META:
        type: string
        description: "Branch name/Custom version identifier"
        required: false
        default: "susfs-main/DareDevilü™Ñ"
     

jobs:
  notify_start:
    name: Notify Start üöÄ
    runs-on: ubuntu-latest
    steps:
      - name: Get current time
        id: get_time
        run: echo "timestamp=$(TZ='Asia/Kolkata' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # - name: Send Telegram message on start
      #   uses: appleboy/telegram-action@master
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID_PERSONAL }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     format: markdown
      #     message: |
      #       *üöÄ Build Initiated*
      #       ------------------------------------
      #       *Workflow:* `${{ github.workflow }}`
      #       *Run:* `#${{ github.run_number }}`
      #       *Triggered by:* `${{ github.triggering_actor }}`
      #       *Commit:* `${{ github.sha }}`
      #       *Started at:* `${{ steps.get_time.outputs.timestamp }}` IST
      #       ------------------------------------
      #       [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
  build:
    needs: notify_start
    name: ${{ github.event.inputs.FAST_BUILD == 'true' && ' [FAST]' || '' }}For ${{ github.event.inputs.FILE }} ${{ github.event.inputs.SUFFIX }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Input Combinations
        run: |
          echo "üîß Validating input combinations..."
          FILE="${{ github.event.inputs.FILE }}"
          
          # Define valid combinations with base model only (no _v/_t/_u...)
          declare -A VALID_COMBINATIONS=(
            ["manifest_stock"]="mt6983 android12 5.10"
          )

          # Recursively strip "_[a-z]+" suffixes to match base key
          get_combination() {
            local key="$1"
            while true; do
              if [[ -n "${VALID_COMBINATIONS[$key]+_}" ]]; then
                echo "${VALID_COMBINATIONS[$key]}"
                return 0
              fi
              if [[ "$key" =~ ^(.+)_([a-z]+)$ ]]; then
                key="${BASH_REMATCH[1]}"
              else
                return 1
              fi
            done
          }

          # Try to resolve FILE to a valid combination
          COMBINATION="$(get_combination "$FILE")" || {
            echo "‚ùå Unknown FILE: $FILE"
            echo "Valid base models:"
            for model in "${!VALID_COMBINATIONS[@]}"; do
              echo "- $model: ${VALID_COMBINATIONS[$model]}"
            done
            exit 1
          }

          # Split the combination into fields
          read CPU ANDROID_VERSION KERNEL_VERSION <<< "$COMBINATION"

          echo "‚úÖ Valid combination: FILE=$FILE, CPU=$CPU, ANDROID_VERSION=$ANDROID_VERSION, KERNEL_VERSION=$KERNEL_VERSION"
          
          # Export to environment
          echo "CPU=$CPU" >> $GITHUB_ENV
          echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          
          # Set BUILD_METHOD based on ANDROID_VERSION and KERNEL_VERSION
          if [[ "$ANDROID_VERSION" == "android12" && "$KERNEL_VERSION" == "5.10" ]]; then
            echo "BUILD_METHOD=perf" >> $GITHUB_ENV
          else
            echo "BUILD_METHOD=gki" >> $GITHUB_ENV
          fi

      - name: Check Disk Space
        run: df -h

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"
          echo "set: $HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "hemasai1109"
          git config --global user.email "pandunelluri.1109@gmail.com"


      - name: Configure APTC
        run: |
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
          echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
          echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Dir::State::lists \"$APT_CACHE_DIR/lists\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Check-Valid-Until \"false\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Languages \"none\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          sudo chown -R $USER:$USER "$APT_CACHE_DIR"

      - name: Set APT Cache
        uses: actions/cache@v3
        with:
          path: ${{ env.HOME }}/apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/sukisu_stock.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Debug Show Selected Inputs
        run: |
          echo "Selected CPU: ${{ env.CPU }}"
          echo "Selected ANDROID_VERSION: ${{ env.ANDROID_VERSION }}"
          echo "Selected KERNEL_VERSION: ${{ env.KERNEL_VERSION }}"
          echo "Selected BUILD_METHOD: ${{ env.BUILD_METHOD }}"
          echo "Selected FILE: ${{ github.event.inputs.FILE }}"
          echo "Custom BUILD_TIME: ${{ github.event.inputs.BUILD_TIME }}"
          echo "Custom SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo "Selected FAST_BUILD: ${{ github.event.inputs.FAST_BUILD }}"
          echo "Selected SUSFS_CI: ${{ github.event.inputs.SUSFS_CI }}"
          echo "Selected VFS: ${{ github.event.inputs.VFS }}"
          echo "Selected KPM: ${{ github.event.inputs.KPM }}"
          echo "Custom KSU_META: ${{ github.event.inputs.KSU_META }}"

      - name: Install Dependencies
        run: |
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR/lists/partial"
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 git curl ccache libelf-dev \
            build-essential flex bison libssl-dev \
            libncurses-dev liblz4-tool zlib1g-dev \
            libxml2-utils rsync unzip
          sudo apt install -y libelf-dev ccache llvm lld

      - name: Restore Ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.event.inputs.FILE }}-${{ env.BUILD_METHOD }}-${{ github.event.inputs.FAST_BUILD == 'true' && 'alpha' || 'beta' }}-15

      - name: Initialize Ccache
        run: |
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              echo "Initializing ccache (${{ env.CCACHE_DIR }})..."
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M ${{ env.CCACHE_MAXSIZE }}
              touch "$INIT_FLAG"
              echo "ccache initialization complete"
            else
              echo "ccache already initialized, skipping"
            fi
          else
            echo "ccache not installed, skipping"
          fi
          ccache -s

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize and Sync Kernel Source
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync
          ls
          cd kernel-5.10
          ls
      - name: Copy and Rename Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp -v kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          echo "pwd cmd!!!!!!!!!!!"
          pwd
          echo "cd kernel_workspace/kernel-5.10 cmd!!!!!!!!!!"
          cd kernel_workspace/kernel-5.10
          echo "ls before rename !!!!!!!!!"
          ls
          
          # --- ADDED STEPS START HERE ---
          
          echo "Renaming the build config file"
          mv build.config.oplus6983-d build.config.oplus6983
          
          echo "Validate the renamed file"
          ls -ls build.config.oplus6983
          
          # --- ADDED STEPS END HERE ---
          
          echo "ls after rename !!!!!!!!!"
          ls
          echo "pwd cmd!!!!!!!!!!!"
          pwd


      - name: Add in bash.rc
        run: |
          echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Vendor Issue Fix
        run: |
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd kernel_workspace"
          cd kernel_workspace
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd kernel_module"
          cd kernel_module
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd .."
          cd ..
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "moving every thing one dir up"
          mv kernel_module/vendor .
          echo "pwd"
          pwd
          echo "ls"
          ls
          cd ..
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "rm -rf kernel_module"
          rm -rf kernel_module

      
      - name: Create thermal Makefile
        run: |
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd kernel_workspace"
          cd kernel_workspace
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd & make file"
          cd vendor/oplus/kernel/cpu/thermal && \touch Makefile && \
          echo "obj-y += horae_shell_temp" > Makefile && \
          echo "obj-y += oplus_ipa_thermal" >> Makefile
          echo "THERMAL MAKEFILE!!!!!!!!!!!!"
          echo "pwd"
          pwd
          echo "ls"
          ls
          cat Makefile

      - name: Create Makefile in fingerprint mtk
        run: |
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd to mtk !!!!!!!!"
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "rm Makefile !!!!!!!!"
          rm Makefile 
          cat > Makefile <<'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/

          ### Capacitive fingerprint sensor
          #obj-$(CONFIG_OPLUS_FINGERPRINT_FPC) += fpc/

          #obj-$(CONFIG_OPLUS_FINGERPRINT_EGIS) += egis/

          ### Optical fingerprint sensor
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          #obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_OPTICAL) += silead_optical_fp/
          #obj-$(CONFIG_OPLUS_FINGERPRINT_EGIS_OPTICAL)   += egis_optical_fp/
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL)  += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP)  += silead/

          ### FEATURE MACRO
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix codec conflict by editing mt6357-accdet.c file
        run: |
          echo "pwd"
          pwd
          echo "ls"
          ls
          echo "cd to codecs !!!!!!!!"
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          echo "pwd"
          pwd
          echo "ls"
          ls
          ls -l mt6357-accdet.c
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c
          grep -E 'mt6357_accdet_read_audio_res' mt6357-accdet.c


      # Custom kernel suffix
      - name: Custom Kernel Suffix if set
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |

          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          FAST_BUILD="${{ github.event.inputs.FAST_BUILD }}"

          for path in \
            kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion; do

            [ -f "$path" ] || continue

            echo "Modifying: $path"

            # Remove -dirty
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              echo "Detected NEW setlocalversion format"
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${ANDROID_VERSION}-${SUFFIX}\"|" "$path"

            elif grep -q 'echo "\$res"' "$path"; then
              echo "Detected OLD setlocalversion format"
              if [ "$FAST_BUILD" = "true" ]; then
                echo "FAST_BUILD enabled: using static res"
                sed -i "s/^res=.*/res=\"-${ANDROID_VERSION}-${SUFFIX}\"/" "$path"
              else
                echo "Standard build: injecting suffix via cut/echo"
                if [[ -f ./kernel-5.10/build_with_bazel.py ]]; then
                  echo "When using the official script and building with build_with_bazel, the build may fail due to a limit on the number of special characters. Please modify the configuration if that happens."
                fi
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
              fi
            else
              echo "Unknown format, appending echo manually"
              echo "echo \"\$res-${SUFFIX}\"" >> "$path"
            fi

            chmod +x "$path"
          done
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix & removed -dirty"

      # - name: Add ${{ matrix.ksu }}
      #   run: |
      #     cd kernel_workspace
      #     if [ "${{ matrix.ksu }}" == "KernelSU" ]; then
      #       curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v1.0.5
      #     elif [ "${{ matrix.ksu }}" == "KernelSU-Next" ]; then
      #       curl -LSs "https://raw.githubusercontent.com/hemasai1109/Custom_kernel_OnePlus_Nord3/refs/heads/main/.github/workflows/ksun.sh" | bash -s next-susfs-a13-5.15-dev
      #     elif [ "${{ matrix.ksu }}" == "SukiSU-Ultra" ]; then
      #       curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
      #     fi
      - name: Add KernelSU Next
        shell: bash
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "kernel_workspace/kernel-5.10"
          
          echo "Adding KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/hemasai1109/Custom_kernel_OnePlus_Nord3/refs/heads/main/.github/workflows/ksun.sh" | bash -s next
          
          git submodule update --init --recursive
          cd KernelSU-Next/kernel
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" 10200)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
          
          git submodule update --init --recursive
      - name: Checkout SUSFS
        run: |
          cd kernel_workspace/kernel-5.10
          git clone https://github.com/TheWildJames/AnyKernel3.git -b gki-2.0
          git clone https://github.com/TheWildJames/kernel_patches.git
          git clone https://gitlab.com/simonpunk/susfs4ksu -b gki-android12-5.10

          if [ "${{ matrix.ksu }}" == "KernelSU" ]; then
            cd susfs4ksu
            git checkout ad931027686e1029b8247dd596e40d4a51eb92c0
          fi

      - name: Apply SUSFS Patches
        run: |
          cd kernel_workspace/kernel-5.10
          
          # cp susfs4ksu/kernel_patches/fs/* fs
          # cp susfs4ksu/kernel_patches/include/linux/* include/linux
          # patch -p1 < susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch

          echo "Applying SUSFS patches..."
          
          # Copy SUSFS patches
          cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch ./
          cp susfs4ksu/kernel_patches/fs/* ./fs/
          cp susfs4ksu/kernel_patches/include/linux/* ./include/linux/

          # if [ "${{ matrix.ksu }}" == "KernelSU" ]; then
          #   cd KernelSU
          #   patch -p1 < ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch
          # fi
          cd ..
          echo "Kernel_Workspace Under things üëç"
          ls
          cd kernel-5.10
          echo "Kernel_Workspace/kernel-5.10 Under things üëç"
          ls
          cd KernelSU-Next
          echo "KernelSU-Next under things üëç"
          ls
          
          echo "Applying next SUSFS patches..."
          susfs_version=$(grep '#define SUSFS_VERSION' ../include/linux/susfs.h | awk -F'"' '{print $2}')
          echo "SUSVER=$susfs_version" >> $GITHUB_ENV
          BASE_VERSION=10200
          cd ./kernel
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" $BASE_VERSION)
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
          cd ..
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "KernelSU Next Version: $KSU_VERSION"
          echo "SusFS Version: $susfs_version"
          # cd ..
          # cd susfs4ksu
          # echo "Susfs4ksu under thingsüëç"
          ls
          case "$susfs_version" in
            # "v1.5.5"|"v1.5.6"|"v1.5.7")
            #   cp "../susfs4ksu/kernel_patches/next/0001-kernel-implement-susfs-v1.5.5-v1.5.7-KSUN-v1.0.8.patch" "./ksun_susfs_latest.patch"
            #   ;;
            # "v1.5.8")
            #   cp ../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            #   patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch  || true
            #   cp "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_apk_sign.c.patch" ./
            #   patch -p1 --forward --fuzz=3 < fix_apk_sign.c.patch
            #   cp "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_core_hook.c.patch" ./
            #   patch -p1 --forward --fuzz=3 < fix_core_hook.c.patch
            #   cp "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_selinux.c.patch" ./
            #   patch -p1 --forward --fuzz=3 < fix_selinux.c.patch
            #   cp "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_ksud.c.patch" ./
            #   patch -p1 --forward --fuzz=3 < fix_ksud.c.patch
            #   ;;
            "v1.5.9")
              cp ../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
              patch -p1 --forward < 10_enable_susfs_for_ksu.patch  || true
              
              for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
                  echo "Patching file: $file.c with fix_$file.c.patch"
                  patch -p1 --forward < "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
              done
              
              #Fix build errors (no rejects; Still giving errors)
              patch -p1 --forward < "../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
              ;;
            *)
              echo "Invalid version: $susfs_version"
              exit 1
              ;;
          esac
          patch -p1 --forward < ksun_susfs_latest.patch || true
          
          
          # Change to common directory and apply SUSFS patch
          cd ../
          
          if [ "${{ inputs.android_version }}" = "android15" ] && [ "${{ inputs.kernel_version }}" = "6.6" ]; then
              if ! grep -qxF '#include <trace/hooks/fs.h>' ./fs/namespace.c; then
                  sed -i '/#include <trace\/hooks\/blk.h>/a #include <trace\/hooks\/fs.h>' ./fs/namespace.c
              else
                  echo "Line already present. Skipping insert."
              fi
          fi
          patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
          
          KERNEL_VERSION="${{ inputs.kernel_version }}"
          MIN_VERSION="5.16"
          
          if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
            echo "Patching ptrace!"
            patch -p1 -F 3 < "kernel_patches/gki_ptrace.patch"
          else
            echo "Kernel >= $MIN_VERSION, skipping ptrace patch"
          fi
          
          if [ "${{ inputs.model }}" == "OPAce5Pro" ] || [ "${{ inputs.model }}" == "OP13" ]; then
            echo "Patching hmbird!"
            echo 'obj-y += hmbird_patch.o' >> ./drivers/Makefile
            patch -p1 -F 3 < "../../../kernel_patches/oneplus/hmbird/hmbird_kernel_patch.patch"
            echo "Patching hmbird files!"
            cd ./kernel/sched
            rm -rf ext.c ext.h build_policy.c slim.h slim_sysctl.c
            patch -p1 -F 3 < "../../../../../kernel_patches/oneplus/hmbird/hmbird_files_patch.patch"
          else
            echo "Not OPAce5Pro / OP13 , skipping fengchi patch"
          fi
      - name: Apply KSUN Hooks
        shell: bash
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "kernel_workspace/kernel-5.10"
          echo "Applying KSUN Hooks..."
          cp kernel_patches/next/scope_min_manual_hooks_v1.4.patch ./manual_hooks.patch
          patch -p1 < ./manual_hooks.patch
          
      - name: Apply Hide Stuff Patches
        shell: bash
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "kernel_workspace/kernel-5.10"
          # Apply additional patch
          cp kernel_patches/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch

      - name: Add Configuration
        run: |
          cat << EOF >> kernel_workspace/kernel-5.10/arch/arm64/configs/gki_defconfig
          # KernelSU and SUSFS Config
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y

          # tmpfs config
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y

          # Additional config
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y

          # BBR Config
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          EOF

          if [ "${{ matrix.ksu }}" == "KernelSU" ]; then
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=n" >> sm7550/arch/arm64/configs/gki_defconfig
          elif [ "${{ matrix.ksu }}" == "KernelSU-Next" ]; then
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> kernel_workspace/kernel-5.10/arch/arm64/configs/gki_defconfig
          elif [ "${{ matrix.ksu }}" == "SukiSU-Ultra" ]; then
            echo "CONFIG_KPM=y" >> sm7550/arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> sm7550/arch/arm64/configs/gki_defconfig
          fi

          # Remove check_defconfi
          ls
          sed -i 's|check_defconfig||g' kernel_workspace/kernel-5.10/build.config.gki

      - name: Custom BUILD_TIME
        if: ${{ github.event.inputs.BUILD_TIME != '' && !contains('Ff', github.event.inputs.BUILD_TIME) }}
        shell: bash
        run: |
          DATESTR="${{ github.event.inputs.BUILD_TIME }}"
          echo "KBUILD_BUILD_TIMESTAMP=${DATESTR}" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_VERSION=1" >> "$GITHUB_ENV"
          cd kernel_workspace/kernel_platform/
            for f in common/scripts/mkcompile_h msm-kernel/scripts/mkcompile_h; do
              if [ -f "$f" ]; then
                echo "Patching mkcompile_h with BUILD_TIME=$DATESTR"
                if grep -q 'UTS_VERSION=' "$f"; then
                  perl -pi -e "s{UTS_VERSION=\"\\\$\\(.*?\\)\"}{UTS_VERSION=\"#1 SMP PREEMPT $DATESTR\"}" "$f"
                else
                  perl -0777 -pi -e "s{cat <<EOF}{cat <<EOF\n#undef UTS_VERSION\n#define UTS_VERSION \"#1 SMP PREEMPT $DATESTR\" } unless /UTS_VERSION/" "$f"
                fi
              fi
              done
      
      - name: Build Kernel FAST
        if: ${{ github.event.inputs.FAST_BUILD == 'true' }}
        id: fast_build
        run: |
          echo "cd kernel_workspace/ !!!!!!!!"
          cd kernel_workspace/
          echo "pwd cmd !!!!!!!"
          pwd
          echo "ls cmd !!!!!!!!!"
          ls
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"
          ./build/build.sh
           ccache -s

     
      - name: Make AnyKernel3_STOCK
        run: |
          git clone https://github.com/hemasai1109/KSU_NEXT_Nord3.git --depth=1
          echo "Copying Image.gz to Anykernel3_STOCK_NORD3/"
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz KSU_NEXT_Nord3/Image.gz


      - name: Set zip Suffix
        id: suffix
        run: |
          echo "value=${{ github.event.inputs.VFS == 'true' && '_VFS' || '' }}${{ github.event.inputs.ZRAM == 'true' && '_LZ4KD' || '' }}${{ github.event.inputs.KPM == 'true' && '_KPM' || '' }}${{ github.event.inputs.SCHED== 'true' && '_SCHED' || '' }}" >> $GITHUB_OUTPUT
      
      - name: Upload AnyKernel3_STOCK
        uses: actions/upload-artifact@v4
        with:
          name: Nebula_Kernel_${{ steps.file_clean.outputs.value }}${{ steps.suffix.outputs.value }}_DareDevil
          path: ./KSU_NEXT_Nord3/*

      - name: Post-build Disk Check
        run: df -h

        
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.release }}

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Download all artifacts
        uses: actions/download-artifact@main
        with:
          path: artifacts

      - name: Set Release Tag and Notes
        run: |
          echo "release=$(date +"%Y-%m-%d")" >> $GITHUB_ENV
          cat << EOF > release_notes.md

          Nebula Kernel for OnePlus Nord 3 / Ace 2V (Vitamin)

          Features:
          -> KernelSU-Next
          -> SUSFS

          Links:
          -> [KernelSU-Next](https://github.com/KernelSU-Next/KernelSU-Next)
          -> [Kernel Flasher](https://github.com/fatalcoder524/KernelFlasher)
          -> [SUSFS Module](https://github.com/sidex15/susfs4ksu-module)

          Notes:
          -> KernelSU-Next is built on main branch
          -> Flash SUSFS Module and make sure SUS SU is enabled
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Nebula Kernel
          tag_name: ${{ env.release }}
          body_path: release_notes.md

      - name: Upload Release Assets
        run: |
          for file in $(find artifacts -type f -name "*.zip" -o -name "*.img"); do
            echo "Uploading $file..."
            gh release upload "${{ env.release }}" "$file"
          done
        env:
          GH_TOKEN: ${{ github.token }}
